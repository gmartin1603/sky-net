@page "/"

@using SkyNet.Simulator.Contracts
@using SkyNet.Simulator.Dashboard.Services

@inject SimApiClient Api
@inject DaemonClientOptions Options
@inject NavigationManager Nav

<PageTitle>SkyNet Dashboard</PageTitle>

<h1>Simulations</h1>
<p>Daemon: <code>@Options.BaseUrl</code></p>

<p>Select a scenario to open its live telemetry view.</p>

@if (!string.IsNullOrWhiteSpace(_error))
{
	<p style="color: darkred;"><b>Error:</b> @_error</p>
}

@if (_sims is null)
{
	<p>Loading simulations...</p>
}
else
{
	<table class="table">
		<thead>
			<tr>
				<th>Name</th>
				<th>Id</th>
				<th>Description</th>
				<th></th>
			</tr>
		</thead>
		<tbody>
			@foreach (var sim in _sims)
			{
				var isActive = string.Equals(sim.Id, _activeId, StringComparison.OrdinalIgnoreCase);
				<tr>
					<td><b>@sim.Name</b>@(isActive ? " (active)" : "")</td>
					<td><code>@sim.Id</code></td>
					<td>@sim.Description</td>
					<td style="white-space: nowrap;">
						<button @onclick="() => Open(sim.Id)">Open</button>
					</td>
				</tr>
			}
		</tbody>
	</table>
}

@code {
	private SimulationInfoDto[]? _sims;
	private string? _activeId;
	private string? _error;

	protected override async Task OnInitializedAsync()
	{
		var cts = new CancellationTokenSource();
		try
		{
			_activeId = await Api.GetActiveSimulationIdAsync(cts.Token);
			_sims = await Api.GetSimulationsAsync(cts.Token);
		}
		catch (Exception ex)
		{
			_error = ex.Message;
		}
	}

	private void Open(string simId)	=> Nav.NavigateTo($"sim/{Uri.EscapeDataString(simId)}");
}

