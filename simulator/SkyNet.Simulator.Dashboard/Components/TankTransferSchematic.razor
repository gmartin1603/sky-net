@using SkyNet.Simulator.Contracts
@using SkyNet.Simulator.Dashboard.Services

@inject SimApiClient Api

@if (Snapshot is null)
{
	<div>Waiting for telemetry...</div>
}
else
{
	var layout = Layout ?? TankTransferSchematicLayout.Default;
	var sourceCenterX = layout.SourceX + (layout.BoxWidth / 2.0);
	var sourceBottomY = layout.TopRowY + layout.TankBottomAnchorY;
	var airlockTopY = layout.BottomRowY + layout.EquipmentTopAnchorY;
	var equipmentMidY = layout.BottomRowY + layout.EquipmentMidAnchorY;
	var blowerRightX = layout.BlowerX + layout.BoxWidth;
	var airlockLeftX = layout.AirlockX;
	var airlockRightX = layout.AirlockX + layout.BoxWidth;
	var blowlineLeftX = layout.BlowlineX;
	var blowlineRightX = layout.BlowlineX + layout.BoxWidth;
	var destinationInletX = layout.DestinationX + layout.DestinationInletOffsetX;
	var destinationInletY = layout.TopRowY + layout.DestinationInletAnchorY;
	var canvasWidth = layout.CanvasWidth.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture);
	var canvasHeight = layout.CanvasHeight.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture);

	<div style="position: relative; max-width: @(layout.CanvasWidth.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; height: @(layout.CanvasHeight.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; margin: 0 auto;">
		<svg viewBox="@($"0 0 {canvasWidth} {canvasHeight}")" style="position:absolute; inset: 0; width: 100%; height: 100%; pointer-events: none;">
			<defs>
				<marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
					<path d="M0,0 L10,3 L0,6 z" fill="currentColor"></path>
				</marker>
			</defs>

			@{
				var permitted = TransferPermitted; // user requested arrows represent 'permitted flow'
				var color = permitted ? "var(--schematic-flow-on)" : "var(--schematic-flow-off)";
				var strokeWidth = permitted ? 4 : 3;
			}

			<g style="color: @color;">
				<path d="M@sourceCenterX @sourceBottomY L@sourceCenterX @airlockTopY" fill="none" stroke="currentColor" stroke-width="@strokeWidth" marker-end="url(#arrow)" />
				<path d="M@blowerRightX @equipmentMidY L@airlockLeftX @equipmentMidY" fill="none" stroke="currentColor" stroke-width="@strokeWidth" marker-end="url(#arrow)" />
				<path d="M@airlockRightX @equipmentMidY L@blowlineLeftX @equipmentMidY" fill="none" stroke="currentColor" stroke-width="@strokeWidth" marker-end="url(#arrow)" />
				<path d="M@blowlineRightX @equipmentMidY L@destinationInletX @destinationInletY" fill="none" stroke="currentColor" stroke-width="@strokeWidth" marker-end="url(#arrow)" />
			</g>
		</svg>

		<div style="position: absolute; left: @(layout.SourceX.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; top: @(layout.TopRowY.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; width: @(layout.BoxWidth.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px;">
				<SchematicBox Title="Source Tank" IsOn="@TransferPermitted" IsClickable="false" Lines="@SourceTankLines" />
		</div>

		<div style="position: absolute; left: @(layout.DestinationX.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; top: @(layout.TopRowY.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; width: @(layout.BoxWidth.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px;">
				<SchematicBox Title="Destination Tank" IsOn="@TransferPermitted" IsClickable="false" Lines="@DestinationTankLines" />
		</div>

		<div style="position: absolute; left: @(layout.BlowerX.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; top: @(layout.BottomRowY.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; width: @(layout.BoxWidth.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px;">
				<SchematicBox Title="Blower" IsOn="@BlowerRunning" StatusText="@BlowerStatus" OnClick="@(() => ToggleAsync(ParamBlowerEnable))" Lines="@BlowerLines" />
		</div>

		<div style="position: absolute; left: @(layout.AirlockX.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; top: @(layout.BottomRowY.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; width: @(layout.BoxWidth.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px;">
				<SchematicBox Title="Rotary Airlock" IsOn="@AirlockRunning" StatusText="@AirlockStatus" OnClick="@(() => ToggleAsync(ParamAirlockEnable))" Lines="@AirlockLines" />
		</div>

		<div style="position: absolute; left: @(layout.BlowlineX.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; top: @(layout.BottomRowY.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px; width: @(layout.BoxWidth.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture))px;">
				<SchematicBox Title="Blowline" IsOn="@TransferPermitted" IsClickable="false" Lines="@BlowlineLines" />
		</div>
	</div>
}

@code {
	[Parameter] public string SimId { get; set; } = string.Empty;
	[Parameter] public TelemetrySnapshot? Snapshot { get; set; }
	[Parameter] public TankTransferSchematicLayout? Layout { get; set; }

	private const string ParamBlowerEnable = "BlowerEnable";
	private const string ParamAirlockEnable = "AirlockEnable";

	private async Task ToggleAsync(string parameterName)
	{
		if (Snapshot is null || string.IsNullOrWhiteSpace(SimId))
		{
			return;
		}

		if (!Snapshot.Parameters.TryGetValue(parameterName, out var current))
		{
			current = 0;
		}

		var next = current >= 0.5 ? 0.0 : 1.0;
		await Api.SetParameterAsync(SimId, parameterName, next);
	}

	private double GetSignal(string name) => Snapshot?.Signals.TryGetValue(name, out var v) == true ? v : double.NaN;

	private bool BlowerRunning => GetSignal("BlowerRunning") >= 0.5;
	private bool AirlockRunning => GetSignal("AirlockRunning") >= 0.5;
	private bool TransferPermitted => BlowerRunning; // matches arrow logic
	private string BlowerStatus => BlowerRunning ? "Running" : "Stopped";
	private string AirlockStatus => AirlockRunning ? "Running" : "Stopped";

	private double SourceTankWeight => GetSignal("SourceTankWeightLb");
	private double DestinationTankWeight => GetSignal("DestinationTankWeightLb");
	private double TransferRateLbPerSec => GetSignal("TransferRateLbPerSec");
	private double BlowlinePressurePsi => GetSignal("BlowlinePressurePsi");
	private double BlowlinePressureCmdPsi => GetSignal("BlowlinePressureCommandPsi");
	private double AirlockSpeedHz => GetSignal("AirlockSpeedHz");
	private double BlowerMotorPercentFla => GetSignal("BlowerMotorPercentFla");

	private bool IsStarved => GetSignal("IsStarved") >= 0.5;
	private bool IsFull => GetSignal("IsFull") >= 0.5;

	private SchematicBox.Line[] SourceTankLines =>
	[
		new("Weight", $"{SourceTankWeight:0.#} lb"),
		new("Starved", IsStarved ? "YES" : "no"),
	];

	private SchematicBox.Line[] AirlockLines =>
	[
		new("Enable", AirlockRunning ? "1" : "0"),
		new("Speed", $"{AirlockSpeedHz:0.0} Hz"),
	];

	private SchematicBox.Line[] BlowlineLines =>
	[
		new("Pressure", $"{BlowlinePressurePsi:0.0} psi"),
		new("Transfer", $"{TransferRateLbPerSec:0.0} lb/s"),
	];

	private SchematicBox.Line[] DestinationTankLines =>
	[
		new("Weight", $"{DestinationTankWeight:0.#} lb"),
		new("Full", IsFull ? "YES" : "no"),
	];

	private SchematicBox.Line[] BlowerLines =>
	[
		new("Enable", BlowerRunning ? "1" : "0"),
		new("Load", $"{BlowerMotorPercentFla:0.0}%"),
		new("P cmd", $"{BlowlinePressureCmdPsi:0.0} psi"),
	];
}
